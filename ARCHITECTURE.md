# Архитектура Advert Master Server

## Обзор

Микросервисная архитектура на базе NestJS с разделением по доменам.

## Сервисы

### 1. API Gateway (порт 3000)
- Единая точка входа для всех запросов
- Роутинг к микросервисам
- CORS, валидация
- Проксирование запросов

### 2. Auth Service (порт 3001)
- Аутентификация (JWT)
- Регистрация (email/phone)
- OAuth (Google)
- OTP (SMS)
- Восстановление пароля
- Управление пользователями
- Загрузка аватаров (S3)

**База данных:** PostgreSQL

### 3. Adverts Service (порт 3002)
- CRUD объявлений
- Категории
- Загрузка фото (S3)
- Сортировка, фильтрация
- Cron задачи (обновление VIP/TOP, удаление истекших)

**База данных:** MongoDB

### 4. User Service (порт 3003)
- Профили пользователей
- Избранное

**База данных:** PostgreSQL + MongoDB (для избранного)

### 5. Search Service (порт 3004)
- Поиск объявлений
- Популярные запросы
- Рекомендации
- Курсы валют

**База данных:** MongoDB

### 6. Payments Service (порт 3005)
- Stripe интеграция
- Создание PaymentIntent

**База данных:** Нет (stateless)

### 7. Archive Service (порт 3006)
- Архив объявлений
- Перемещение в архив
- Удаление из архива

**База данных:** MongoDB

## Коммуникация

- **REST API** - синхронная коммуникация между сервисами
- **HTTP** - через внутреннюю Docker сеть
- **Service Discovery** - через Docker Compose имена сервисов

## Базы данных

- **PostgreSQL** (2 инстанса):
  - `postgres-auth` - для auth-service
  - `postgres-user` - для user-service

- **MongoDB** (3 инстанса):
  - `mongodb-adverts` - для adverts-service
  - `mongodb-search` - для search-service
  - `mongodb-archive` - для archive-service

- **Redis** (1 инстанс):
  - Кеш, сессии, OTP коды

## Интеграции

- **AWS S3** - хранение файлов (аватары, фото объявлений)
- **Stripe** - платежи
- **Google OAuth** - социальная аутентификация
- **GatewayAPI** - SMS для OTP
- **FreeCurrencyAPI** - курсы валют

## Развертывание

Все сервисы контейнеризированы через Docker Compose.

```bash
docker-compose up -d
```

## Мониторинг

- Health checks для каждого сервиса
- Логирование через console.log (можно улучшить)
- Метрики (можно добавить Prometheus)

## Безопасность

- JWT токены для аутентификации
- CORS настройки
- Валидация входных данных
- Изоляция сервисов через Docker сети
